import{_ as pe,M as me,x as ve,p as fe,r as l,f as xe,w as ye,v as S,g as _e,y as T,c as u,o as n,m as r,u as o,l as i,a as s,z as ge,t as d,d as p,A as be,k as he,b as Q,N as A,O,P as we,Q as ke}from"./index-CrsxHHBg.js";import{_ as De}from"./failer-Dtv5Mqu6.js";import{f as Ve}from"./formateDate-DG_0Qep_.js";import{c as Ce,a as U,d as Se,u as Te}from"./index.esm-B-Na5t5A.js";import{_ as H}from"./InputField.vue_vue_type_script_setup_true_lang-Dcq93KVQ.js";const Ee={class:"flex flex-col gap-4 w-full"},Me={key:0,class:"text-center"},Fe=["onClick"],ze={key:1,class:"text-start"},Ue=["title","onClick"],Ne={key:0,class:"text-center"},$e=["href"],qe={key:1,class:"text-center"},Be={class:"flex flex-col gap-y-1 pt-3"},Ie={key:1,class:"text-red-500 text-sm text-start"},Qe={key:2,class:"bg-red-100 rounded-[12px] flex gap-2 py-3 mt-4 px-4 items-center text-sm text-start"},Ae={class:"flex justify-end items-center w-full gap-2 mt-4"},Oe=["disabled"],Pe={key:0},Re={key:1},Ge={class:"flex flex-col gap-4"},He={__name:"TransactionsList",setup(Le){const k=me(),L=ve(),m=fe(),D=l(!1),E=l(!1),M=l(!1),P=l([]),v=l(!1),_=l(""),g=l("all"),f=l({start:null,end:null}),j=l([{value:"trader",label:"تاجر"},{value:"driver",label:"سائق"}]),J=l([{value:"deposit",label:"إيداع"},{value:"withdraw",label:"سحب"},{value:"expense",label:"مصروفات"}]),K={all:"الكل",deposit:"إيداع",withdraw:"سحب",expense:"مصروفات"},c=l({count:0,next:null,previous:null,page:1,pageSize:10}),W=xe(()=>(c.value.page-1)*c.value.pageSize),X=[{label:"اسم الحساب",key:"user_account"},{label:"التاريخ",key:"created_at"},{label:"المبلغ",key:"amount"},{label:"نوع المعاملة",key:"transaction_type"},{label:"مرتجع",key:"is_rolled_back"},{label:"وسائط",key:"file"},{label:"الشحنة",key:"order"},{label:"الملاحظات",key:"notes"}],Y=Ce({user_type:U().required("نوع المستخدم مطلوب"),user_account:U().required("اسم   حساب المستخدم مطلوب"),amount:Se().transform((a,e)=>e===""?void 0:a).required("المبلغ مطلوب").positive("يجب أن يكون المبلغ أكبر من 0").typeError("يجب أن يكون المبلغ رقماً"),transaction_type:U().required("نوع المعاملة مطلوب"),notes:U().nullable()}),{handleSubmit:Z,resetForm:ee,setFieldValue:te,errors:N,defineField:$}=Te({validationSchema:Y,initialValues:{user_type:"",user_account:"",amount:"",transaction_type:"",notes:""}}),[b]=$("user_type"),[q]=$("user_account"),[B]=$("transaction_type"),h=l(null),F=l(null),V=l(""),x=l(""),C=l([]),z=l(""),ae=a=>{const e=a.target.files[0];if(e){if(e.size>5*1024*1024){V.value="حجم الملف يجب أن يكون أقل من 5 ميجابايت",a.target.value="";return}F.value=e,V.value=""}},se=()=>{h.value=null,ee(),F.value=null,V.value="",x.value="",D.value=!0},I=()=>{D.value=!1,E.value=!1,x.value=""},le=()=>{M.value=!1,z.value=""},oe=a=>{z.value=a,M.value=!0},ne=async()=>{if(!b.value){C.value=[];return}try{const a=await S.get(`users/?no_paginate=true&role=${b.value}`);C.value=a.data.results.map(e=>({value:e.id,label:e.full_name})),te("user_account","")}catch{m.error("فشل في تحميل قائمة المستخدمين"),C.value=[]}},w=(a=1)=>{v.value=!0;const e={page:a,page_size:c.value.pageSize};_.value&&_.value.trim()&&(e.search=_.value.trim()),g.value&&g.value!=="all"&&(e.transaction_type=g.value),f.value?.start&&f.value?.end&&(e.start_date=f.value.start,e.end_date=f.value.end),k.params.id&&(e.user_account=k.params.id),S.get("transactions/user/",{params:e}).then(y=>{P.value=y.data.results||[],c.value={count:y?.data?.count||0,next:y?.data?.next,previous:y?.data?.previous,page:a,pageSize:c.value.pageSize}}).catch(y=>{m.error("فشل في تحميل البيانات")}).finally(()=>{v.value=!1})},re=a=>{_.value=a.search,g.value=a.status,f.value=a.date,w(1)};ye(()=>k.params.id,a=>{a&&w(1)});const R=Z(async a=>{v.value=!0,x.value="";try{const e=new FormData;e.append("user_account",Number(a.user_account)),e.append("amount",a.amount),e.append("transaction_type",a.transaction_type),F.value&&e.append("file",F.value),a.notes&&a.notes.trim()&&e.append("notes",a.notes.trim()),h.value?(await S.patch(`transactions/user/${h.value}/`,e,{headers:{"Content-Type":"multipart/form-data"}}),m.success("تم تعديل المعاملة بنجاح")):(await S.post("transactions/user/",e,{headers:{"Content-Type":"multipart/form-data"}}),m.success("تم إضافة المعاملة بنجاح")),D.value=!1,w(c.value.page)}catch(e){x.value=e.response?.data?.detail||e.response?.data?.message||"حدث خطأ أثناء العملية",m.error(x.value)}finally{v.value=!1}}),ue=async()=>{try{await S.delete(`transactions/user/${h.value}/`),m.success("تم حذف المعاملة بنجاح"),E.value=!1,w(c.value.page)}catch{m.error("فشل في حذف المعاملة")}};return _e(()=>{w(1)}),(a,e)=>{const y=T("Header"),ie=T("DataFilter"),de=T("DataTable"),G=T("GenericModal"),ce=T("DeletModal");return n(),u("div",Ee,[r(y,{title:"سجل المعاملات المالية",buttonText:"إضافة معاملة جديدة",onBtnClick:se,subtitle:o(k).query?.traderName||o(k).query?.driverName,type:"1"},null,8,["subtitle"]),r(ie,{searchQuery:_.value,"onUpdate:searchQuery":e[0]||(e[0]=t=>_.value=t),selectedStatus:g.value,"onUpdate:selectedStatus":e[1]||(e[1]=t=>g.value=t),selectedDate:f.value,"onUpdate:selectedDate":e[2]||(e[2]=t=>f.value=t),statusOptions:K,showDateFilter:!0,searchPlaceholder:"ابحث برقم الحساب أو الاسم",onFilter:re},null,8,["searchQuery","selectedStatus","selectedDate"]),r(de,{headers:X,data:P.value,loading:v.value,pagination:c.value,startIndex:W.value,onPageChange:w},{order:i(({row:t})=>[s("div",null,[t.order?(n(),u("div",Me,[s("div",{onClick:()=>o(L).push({name:"view-one-shipments",params:{id:t.order}}),rel:"noopener noreferrer",class:"text-blue-600 underline text-start cursor-pointer"}," عرض ",8,Fe)])):(n(),u("div",ze,"-"))])]),user_account:i(({row:t})=>[p(d(t.user_account.full_name)+" ( "+d(t.user_account.role==="trader"?"تاجر":"سائق")+" ) ",1)]),notes:i(({row:t})=>[s("p",{title:t?.notes,onClick:je=>oe(t?.notes)},d(t?.notes&&t.notes.length>15?t.notes.slice(0,15)+"...":t?.notes||"-"),9,Ue)]),file:i(({row:t})=>[t.file?(n(),u("span",Ne,[s("a",{href:t.file,target:"_blank",rel:"noopener noreferrer",class:"text-blue-600 underline"}," عرض ",8,$e)])):(n(),u("span",qe,"-"))]),created_at:i(({row:t})=>[p(d(o(Ve)(t.created)),1)]),is_rolled_back:i(({row:t})=>[p(d(t.is_rolled_back?"نعم":"لا"),1)]),transaction_type:i(({row:t})=>[s("p",{class:ge(["px-2 py-1 rounded-[12px] text-center text-sm w-40",t.transaction_type==="deposit"?"bg-green-100 text-green-800":t.transaction_type==="withdraw"?"bg-red-100 text-red-800":t.transaction_type==="expense"?"bg-yellow-100 text-yellow-800":"bg-gray-100 text-gray-800"])},d(t.transaction_type==="deposit"?"إيداع":t.transaction_type==="withdraw"?"سحب":"مصروفات"),3)]),_:1},8,["data","loading","pagination","startIndex"]),r(G,{modelValue:D.value,"onUpdate:modelValue":e[7]||(e[7]=t=>D.value=t),title:h.value?"تعديل معاملة":"إضافة معاملة جديدة",description:"ادخل تفاصيل المعاملة لتأكيد الإضافة","show-header-icon":!0,size:"large","show-footer":!1,onClose:I},{default:i(()=>[s("form",{onSubmit:e[6]||(e[6]=be((...t)=>o(R)&&o(R)(...t),["prevent"]))},[s("div",Be,[s("div",null,[e[11]||(e[11]=s("label",{class:"text-gray-700 text-sm text-start w-full"},[p(" نوع المستخدم "),s("span",{class:"text-red-500"},"*")],-1)),r(A,{name:"user_type",modelValue:o(b),"onUpdate:modelValue":e[3]||(e[3]=t=>O(b)?b.value=t:null),options:j.value,onChange:ne,class:"w-full mt-2 min-h-[48px] text-gray-700 bg-white focus:outline-none",error:o(N).user_type},null,8,["modelValue","options","error"])]),e[13]||(e[13]=s("label",{class:"text-gray-700 text-sm text-start w-full mt-4"},[p(" اسم حساب المستخدم"),s("span",{class:"text-red-500"},"*")],-1)),C.value?(n(),he(A,{key:0,name:"user_account",modelValue:o(q),"onUpdate:modelValue":e[4]||(e[4]=t=>O(q)?q.value=t:null),options:C.value,disabled:!o(b),class:"w-full mt-2 min-h-[48px] text-gray-700 bg-white focus:outline-none",error:o(N).user_account},null,8,["modelValue","options","disabled","error"])):Q("",!0),e[14]||(e[14]=s("label",{class:"text-gray-700 text-sm text-start mt-4"},[p(" المبلغ "),s("span",{class:"text-red-500"},"*")],-1)),r(H,{name:"amount",type:"number",placeholder:"أدخل المبلغ",class:"mt-2"}),e[15]||(e[15]=s("label",{class:"text-gray-700 text-sm text-start mt-4"},[p(" نوع المعاملة "),s("span",{class:"text-red-500"},"*")],-1)),r(A,{name:"transaction_type",modelValue:o(B),"onUpdate:modelValue":e[5]||(e[5]=t=>O(B)?B.value=t:null),options:J.value,class:"w-full mt-2 min-h-[48px] text-gray-700 bg-white focus:outline-none",error:o(N).transaction_type},null,8,["modelValue","options","error"]),e[16]||(e[16]=s("label",{class:"text-gray-700 text-sm text-start mt-4"}," المرفقات ",-1)),s("input",{type:"file",onChange:ae,accept:"image/*,.pdf",class:"w-full px-4 py-2 mt-2 min-h-[48px] text-gray-700 bg-white border border-[#DEDEDE] rounded-[12px] focus:outline-none"},null,32),V.value?(n(),u("span",Ie,d(V.value),1)):Q("",!0),e[17]||(e[17]=s("label",{class:"text-gray-700 text-sm text-start mt-4"}," ملاحظات ",-1)),r(H,{name:"notes",type:"text",placeholder:"أدخل ملاحظاتك هنا",class:"mt-2"}),x.value?(n(),u("span",Qe,[e[12]||(e[12]=s("img",{src:De,alt:"",class:"h-6"},null,-1)),p(" "+d(x.value),1)])):Q("",!0),s("div",Ae,[s("button",{onClick:I,type:"button",class:"w-fit px-8 py-2 text-black bg-[#DEDEDE] rounded-[12px]"}," إلغاء "),s("button",{type:"submit",class:"w-[160px] px-4 py-2 text-white disabled:opacity-50 disabled:cursor-not-allowed bg-[#0E5895] rounded-[12px]",disabled:v.value},[v.value?(n(),u("span",Pe,"جاري ...")):(n(),u("span",Re,d(h.value?"تأكيد التعديل":"تأكيد الإضافة"),1))],8,Oe)])])],32)]),_:1},8,["modelValue","title"]),r(G,{modelValue:M.value,"onUpdate:modelValue":e[9]||(e[9]=t=>M.value=t),title:"تفاصيل المعاملة",description:"","show-header-icon":!0,size:"large","show-footer":!1,onClose:le},{default:i(()=>[s("div",Ge,[s("div",null,[e[18]||(e[18]=s("label",{class:"text-gray-700 text-sm font-medium"},"الملاحظات:",-1)),we(s("textarea",{disabled:"","onUpdate:modelValue":e[8]||(e[8]=t=>z.value=t),rows:"6",class:"w-full px-4 py-2 mt-2 text-gray-700 bg-gray-50 border border-[#DEDEDE] rounded-[12px] focus:outline-none resize-none"},null,512),[[ke,z.value]])])])]),_:1},8,["modelValue"]),r(ce,{modelValue:E.value,"onUpdate:modelValue":e[10]||(e[10]=t=>E.value=t),title:"هل أنت متأكد من حذف المعاملة؟",description:"سيؤدي ذلك إلى حذف جميع تفاصيلها","show-confirm-button":!0,"show-cancel-button":!0,onClose:I,onConfirm:ue},null,8,["modelValue"])])}}},Ze=pe(He,[["__scopeId","data-v-e092f386"]]);export{Ze as default};
