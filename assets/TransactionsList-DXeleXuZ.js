import{_ as ce,M as pe,x as me,p as ve,r as l,f as fe,w as xe,v as S,g as ye,y as T,c as u,o as n,m as r,u as o,l as i,a,z as _e,t as d,d as p,A as ge,k as be,b as Q,N as A,O,P as he,Q as we}from"./index-pUu63qh5.js";import{_ as ke}from"./failer-Dtv5Mqu6.js";import{f as De}from"./formateDate-DG_0Qep_.js";import{c as Ve,a as M,d as Ce,u as Se}from"./index.esm-ClxWu_jM.js";import{_ as H}from"./InputField.vue_vue_type_script_setup_true_lang-CTZjgrED.js";const Te={class:"flex flex-col gap-4 w-full"},Ee={key:0,class:"text-center"},Fe=["onClick"],Me={key:1,class:"text-start"},ze=["title"],Ue={key:0,class:"text-center"},Ne=["href"],$e={key:1,class:"text-center"},qe={class:"flex flex-col gap-y-1 pt-3"},Be={key:1,class:"text-red-500 text-sm text-start"},Ie={key:2,class:"bg-red-100 rounded-[12px] flex gap-2 py-3 mt-4 px-4 items-center text-sm text-start"},Qe={class:"flex justify-end items-center w-full gap-2 mt-4"},Ae=["disabled"],Oe={key:0},Pe={key:1},Re={class:"flex flex-col gap-4"},Ge={__name:"TransactionsList",setup(He){const k=pe(),L=me(),m=ve(),D=l(!1),E=l(!1),z=l(!1),P=l([]),v=l(!1),_=l(""),g=l("all"),f=l({start:null,end:null}),j=l([{value:"trader",label:"تاجر"},{value:"driver",label:"سائق"}]),J=l([{value:"deposit",label:"إيداع"},{value:"withdraw",label:"سحب"},{value:"expense",label:"مصروفات"}]),K={all:"الكل",deposit:"إيداع",withdraw:"سحب",expense:"مصروفات"},c=l({count:0,next:null,previous:null,page:1,pageSize:10}),W=fe(()=>(c.value.page-1)*c.value.pageSize),X=[{label:"اسم الحساب",key:"user_account"},{label:"التاريخ",key:"created_at"},{label:"المبلغ",key:"amount"},{label:"نوع المعاملة",key:"transaction_type"},{label:"مرتجع",key:"is_rolled_back"},{label:"وسائط",key:"file"},{label:"الشحنة",key:"order"},{label:"الملاحظات",key:"notes"}],Y=Ve({user_type:M().required("نوع المستخدم مطلوب"),user_account:M().required("رقم حساب المستخدم مطلوب"),amount:Ce().transform((s,e)=>e===""?void 0:s).required("المبلغ مطلوب").positive("يجب أن يكون المبلغ أكبر من 0").typeError("يجب أن يكون المبلغ رقماً"),transaction_type:M().required("نوع المعاملة مطلوب"),notes:M().nullable()}),{handleSubmit:Z,resetForm:ee,setFieldValue:te,errors:U,defineField:N}=Se({validationSchema:Y,initialValues:{user_type:"",user_account:"",amount:"",transaction_type:"",notes:""}}),[b]=N("user_type"),[$]=N("user_account"),[q]=N("transaction_type"),h=l(null),F=l(null),V=l(""),x=l(""),C=l([]),B=l(""),ae=s=>{const e=s.target.files[0];if(e){if(e.size>5*1024*1024){V.value="حجم الملف يجب أن يكون أقل من 5 ميجابايت",s.target.value="";return}F.value=e,V.value=""}},se=()=>{h.value=null,ee(),F.value=null,V.value="",x.value="",D.value=!0},I=()=>{D.value=!1,E.value=!1,x.value=""},le=()=>{z.value=!1,B.value=""},oe=async()=>{if(!b.value){C.value=[];return}try{const s=await S.get(`users/?no_paginate=true&role=${b.value}`);C.value=s.data.results.map(e=>({value:e.id,label:e.full_name})),te("user_account","")}catch{m.error("فشل في تحميل قائمة المستخدمين"),C.value=[]}},w=(s=1)=>{v.value=!0;const e={page:s,page_size:c.value.pageSize};_.value&&_.value.trim()&&(e.search=_.value.trim()),g.value&&g.value!=="all"&&(e.transaction_type=g.value),f.value?.start&&f.value?.end&&(e.start_date=f.value.start,e.end_date=f.value.end),k.params.id&&(e.user_account=k.params.id),S.get("transactions/user/",{params:e}).then(y=>{P.value=y.data.results||[],c.value={count:y?.data?.count||0,next:y?.data?.next,previous:y?.data?.previous,page:s,pageSize:c.value.pageSize}}).catch(y=>{m.error("فشل في تحميل البيانات")}).finally(()=>{v.value=!1})},ne=s=>{_.value=s.search,g.value=s.status,f.value=s.date,w(1)};xe(()=>k.params.id,s=>{s&&w(1)});const R=Z(async s=>{v.value=!0,x.value="";try{const e=new FormData;e.append("user_account",Number(s.user_account)),e.append("amount",s.amount),e.append("transaction_type",s.transaction_type),F.value&&e.append("file",F.value),s.notes&&s.notes.trim()&&e.append("notes",s.notes.trim()),h.value?(await S.patch(`transactions/user/${h.value}/`,e,{headers:{"Content-Type":"multipart/form-data"}}),m.success("تم تعديل المعاملة بنجاح")):(await S.post("transactions/user/",e,{headers:{"Content-Type":"multipart/form-data"}}),m.success("تم إضافة المعاملة بنجاح")),D.value=!1,w(c.value.page)}catch(e){x.value=e.response?.data?.detail||e.response?.data?.message||"حدث خطأ أثناء العملية",m.error(x.value)}finally{v.value=!1}}),re=async()=>{try{await S.delete(`transactions/user/${h.value}/`),m.success("تم حذف المعاملة بنجاح"),E.value=!1,w(c.value.page)}catch{m.error("فشل في حذف المعاملة")}};return ye(()=>{w(1)}),(s,e)=>{const y=T("Header"),ue=T("DataFilter"),ie=T("DataTable"),G=T("GenericModal"),de=T("DeletModal");return n(),u("div",Te,[r(y,{title:"سجل المعاملات المالية",buttonText:"إضافة معاملة جديدة",onBtnClick:se,subtitle:o(k).query?.traderName||o(k).query?.driverName,type:"1"},null,8,["subtitle"]),r(ue,{searchQuery:_.value,"onUpdate:searchQuery":e[0]||(e[0]=t=>_.value=t),selectedStatus:g.value,"onUpdate:selectedStatus":e[1]||(e[1]=t=>g.value=t),selectedDate:f.value,"onUpdate:selectedDate":e[2]||(e[2]=t=>f.value=t),statusOptions:K,showDateFilter:!0,searchPlaceholder:"ابحث برقم الحساب أو الاسم",onFilter:ne},null,8,["searchQuery","selectedStatus","selectedDate"]),r(ie,{headers:X,data:P.value,loading:v.value,pagination:c.value,startIndex:W.value,onPageChange:w},{order:i(({row:t})=>[a("div",null,[t.order?(n(),u("div",Ee,[a("div",{onClick:()=>o(L).push({name:"view-one-shipments",params:{id:t.order}}),rel:"noopener noreferrer",class:"text-blue-600 underline text-start cursor-pointer"}," عرض ",8,Fe)])):(n(),u("div",Me,"-"))])]),user_account:i(({row:t})=>[p(d(t.user_account.full_name)+" ( "+d(t.user_account.role==="trader"?"تاجر":"سائق")+" ) ",1)]),notes:i(({row:t})=>[a("p",{title:t?.notes},d(t?.notes&&t.notes.length>15?t.notes.slice(0,15)+"...":t?.notes||"-"),9,ze)]),file:i(({row:t})=>[t.file?(n(),u("span",Ue,[a("a",{href:t.file,target:"_blank",rel:"noopener noreferrer",class:"text-blue-600 underline"}," عرض ",8,Ne)])):(n(),u("span",$e,"-"))]),created_at:i(({row:t})=>[p(d(o(De)(t.created)),1)]),is_rolled_back:i(({row:t})=>[p(d(t.is_rolled_back?"نعم":"لا"),1)]),transaction_type:i(({row:t})=>[a("p",{class:_e(["px-2 py-1 rounded-[12px] text-center text-sm w-40",t.transaction_type==="deposit"?"bg-green-100 text-green-800":t.transaction_type==="withdraw"?"bg-red-100 text-red-800":t.transaction_type==="expense"?"bg-yellow-100 text-yellow-800":"bg-gray-100 text-gray-800"])},d(t.transaction_type==="deposit"?"إيداع":t.transaction_type==="withdraw"?"سحب":"مصروفات"),3)]),_:1},8,["data","loading","pagination","startIndex"]),r(G,{modelValue:D.value,"onUpdate:modelValue":e[7]||(e[7]=t=>D.value=t),title:h.value?"تعديل معاملة":"إضافة معاملة جديدة",description:"ادخل تفاصيل المعاملة لتأكيد الإضافة","show-header-icon":!0,size:"large","show-footer":!1,onClose:I},{default:i(()=>[a("form",{onSubmit:e[6]||(e[6]=ge((...t)=>o(R)&&o(R)(...t),["prevent"]))},[a("div",qe,[a("div",null,[e[11]||(e[11]=a("label",{class:"text-gray-700 text-sm text-start w-full"},[p(" نوع المستخدم "),a("span",{class:"text-red-500"},"*")],-1)),r(A,{name:"user_type",modelValue:o(b),"onUpdate:modelValue":e[3]||(e[3]=t=>O(b)?b.value=t:null),options:j.value,onChange:oe,class:"w-full mt-2 min-h-[48px] text-gray-700 bg-white focus:outline-none",error:o(U).user_type},null,8,["modelValue","options","error"])]),e[13]||(e[13]=a("label",{class:"text-gray-700 text-sm text-start w-full mt-4"},[p(" رقم حساب المستخدم "),a("span",{class:"text-red-500"},"*")],-1)),C.value?(n(),be(A,{key:0,name:"user_account",modelValue:o($),"onUpdate:modelValue":e[4]||(e[4]=t=>O($)?$.value=t:null),options:C.value,disabled:!o(b),class:"w-full mt-2 min-h-[48px] text-gray-700 bg-white focus:outline-none",error:o(U).user_account},null,8,["modelValue","options","disabled","error"])):Q("",!0),e[14]||(e[14]=a("label",{class:"text-gray-700 text-sm text-start mt-4"},[p(" المبلغ "),a("span",{class:"text-red-500"},"*")],-1)),r(H,{name:"amount",type:"number",placeholder:"أدخل المبلغ",class:"mt-2"}),e[15]||(e[15]=a("label",{class:"text-gray-700 text-sm text-start mt-4"},[p(" نوع المعاملة "),a("span",{class:"text-red-500"},"*")],-1)),r(A,{name:"transaction_type",modelValue:o(q),"onUpdate:modelValue":e[5]||(e[5]=t=>O(q)?q.value=t:null),options:J.value,class:"w-full mt-2 min-h-[48px] text-gray-700 bg-white focus:outline-none",error:o(U).transaction_type},null,8,["modelValue","options","error"]),e[16]||(e[16]=a("label",{class:"text-gray-700 text-sm text-start mt-4"}," المرفقات ",-1)),a("input",{type:"file",onChange:ae,accept:"image/*,.pdf",class:"w-full px-4 py-2 mt-2 min-h-[48px] text-gray-700 bg-white border border-[#DEDEDE] rounded-[12px] focus:outline-none"},null,32),V.value?(n(),u("span",Be,d(V.value),1)):Q("",!0),e[17]||(e[17]=a("label",{class:"text-gray-700 text-sm text-start mt-4"}," ملاحظات ",-1)),r(H,{name:"notes",type:"text",placeholder:"أدخل ملاحظاتك هنا",class:"mt-2"}),x.value?(n(),u("span",Ie,[e[12]||(e[12]=a("img",{src:ke,alt:"",class:"h-6"},null,-1)),p(" "+d(x.value),1)])):Q("",!0),a("div",Qe,[a("button",{onClick:I,type:"button",class:"w-fit px-8 py-2 text-black bg-[#DEDEDE] rounded-[12px]"}," إلغاء "),a("button",{type:"submit",class:"w-[160px] px-4 py-2 text-white disabled:opacity-50 disabled:cursor-not-allowed bg-[#0E5895] rounded-[12px]",disabled:v.value},[v.value?(n(),u("span",Oe,"جاري ...")):(n(),u("span",Pe,d(h.value?"تأكيد التعديل":"تأكيد الإضافة"),1))],8,Ae)])])],32)]),_:1},8,["modelValue","title"]),r(G,{modelValue:z.value,"onUpdate:modelValue":e[9]||(e[9]=t=>z.value=t),title:"تفاصيل المعاملة",description:"","show-header-icon":!0,size:"large","show-footer":!1,onClose:le},{default:i(()=>[a("div",Re,[a("div",null,[e[18]||(e[18]=a("label",{class:"text-gray-700 text-sm font-medium"},"الملاحظات:",-1)),he(a("textarea",{disabled:"","onUpdate:modelValue":e[8]||(e[8]=t=>B.value=t),rows:"6",class:"w-full px-4 py-2 mt-2 text-gray-700 bg-gray-50 border border-[#DEDEDE] rounded-[12px] focus:outline-none resize-none"},null,512),[[we,B.value]])])])]),_:1},8,["modelValue"]),r(de,{modelValue:E.value,"onUpdate:modelValue":e[10]||(e[10]=t=>E.value=t),title:"هل أنت متأكد من حذف المعاملة؟",description:"سيؤدي ذلك إلى حذف جميع تفاصيلها","show-confirm-button":!0,"show-cancel-button":!0,onClose:I,onConfirm:re},null,8,["modelValue"])])}}},Xe=ce(Ge,[["__scopeId","data-v-0ef9711b"]]);export{Xe as default};
